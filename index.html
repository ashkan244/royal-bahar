import React, { useState, useMemo, useEffect } from 'react';

// --- Custom SVG Icons (No external dependencies required) ---
const IconBase = ({ children, size = 24, className = "", strokeWidth = 2 }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}>
    {children}
  </svg>
);

const CalendarIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
const UserIcon = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
const HospitalIcon = (props) => <IconBase {...props}><path d="M12 6v4"/><path d="M14 14h-4"/><path d="M14 18h-4"/><path d="M14 8h-4"/><path d="M18 12h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h2"/><path d="M18 22V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v18"/></IconBase>;
const ActivityIcon = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>;
const SunIcon = (props) => <IconBase {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;
const SunsetIcon = (props) => <IconBase {...props}><path d="M12 10V2"/><path d="m4.93 10.93 1.41 1.41"/><path d="M2 18h2"/><path d="M20 18h2"/><path d="m19.07 10.93-1.41 1.41"/><path d="M22 22H2"/><path d="M16 6l-4-4-4 4"/><path d="M16 18a4 4 0 0 0-8 0"/></IconBase>;
const MoonIcon = (props) => <IconBase {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>;
const UsersIcon = (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;

// --- Data Preparation ---
const infectiousData = [
  { date: '1/12', doctor: 'دارابی' }, { date: '2/12', doctor: 'پوراحسانی' },
  { date: '3/12', doctor: 'پوراحسانی' }, { date: '4/12', doctor: 'آرزویی' },
  { date: '5/12', doctor: 'آرزویی' }, { date: '6/12', doctor: 'پوراحسانی' },
  { date: '7/12', doctor: 'شمی پور' }, { date: '8/12', doctor: 'شمی پور' },
  { date: '9/12', doctor: 'پوراحسانی' }, { date: '10/12', doctor: 'پوراحسانی' },
  { date: '11/12', doctor: 'دارابی' }, { date: '12/12', doctor: 'دارابی' },
  { date: '13/12', doctor: 'دارابی' }, { date: '14/12', doctor: 'رضوی' },
  { date: '15/12', doctor: 'دارابی' }, { date: '16/12', doctor: 'دارابی' },
  { date: '17/12', doctor: 'پوراحسانی' }, { date: '18/12', doctor: 'آرزویی' },
  { date: '19/12', doctor: 'آرزویی' }, { date: '20/12', doctor: 'پوراحسانی' },
  { date: '21/12', doctor: 'معارفی' }, { date: '22/12', doctor: 'معارفی' },
  { date: '23/12', doctor: 'پوراحسانی' }, { date: '24/12', doctor: 'پوراحسانی' },
  { date: '25/12', doctor: 'آرزویی' }, { date: '26/12', doctor: 'آرزویی' },
  { date: '27/12', doctor: 'پوراحسانی' }, { date: '28/12', doctor: 'معارفی' },
  { date: '29/12', doctor: 'شمی پور' }
];

const internalData = [
  { date: '1/12', doctor: 'معارفی' }, { date: '2/12', doctor: 'حسن نژاد' },
  { date: '3/12', doctor: 'معارفی' }, { date: '4/12', doctor: 'شمی پور' },
  { date: '5/12', doctor: 'قلاوند' }, { date: '6/12', doctor: 'مظفری' },
  { date: '7/12', doctor: 'شمی پور' }, { date: '8/12', doctor: 'شمی پور' },
  { date: '9/12', doctor: 'مظفری' }, { date: '10/12', doctor: 'معارفی' },
  { date: '11/12', doctor: 'حسن نژاد' }, { date: '12/12', doctor: 'معارفی' },
  { date: '13/12', doctor: 'پورکاوه' }, { date: '14/12', doctor: 'شمی پور' },
  { date: '15/12', doctor: 'پورکاوه' }, { date: '16/12', doctor: 'شمی پور' },
  { date: '17/12', doctor: 'پورکاوه' }, { date: '18/12', doctor: 'قلاوند' },
  { date: '19/12', doctor: 'حسن نژاد' }, { date: '20/12', doctor: 'پورکاوه' },
  { date: '21/12', doctor: 'معارفی' }, { date: '22/12', doctor: 'معارفی' },
  { date: '23/12', doctor: 'شمی پور' }, { date: '24/12', doctor: 'حسن نژاد' },
  { date: '25/12', doctor: 'معارفی' }, { date: '26/12', doctor: 'معارفی' },
  { date: '27/12', doctor: 'شمی پور' }, { date: '28/12', doctor: 'معارفی' },
  { date: '29/12', doctor: 'شمی پور' }
];

const shafaData = [
  { date: '1/12', morning: 'علی مرادی', evening: 'علی مرادی', night: '' },
  { date: '2/12', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '3/12', morning: '', evening: 'بالی زاده', night: 'بالی زاده' },
  { date: '4/12', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '5/12', morning: '', evening: 'بالی زاده', night: 'بالی زاده' },
  { date: '6/12', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '7/12', morning: 'آرزویی', evening: 'حسن نژاد', night: 'حسن نژاد' },
  { date: '8/12', morning: 'علی مرادی', evening: 'حسن نژاد', night: 'حسن نژاد' },
  { date: '9/12', morning: '', evening: 'عباسی', night: 'آرزویی' },
  { date: '10/12', morning: '', evening: 'شمی پور', night: 'شمی پور' },
  { date: '11/12', morning: '', evening: 'قلاوند', night: 'قلاوند' },
  { date: '12/12', morning: '', evening: 'مظفری', night: 'مظفری' },
  { date: '13/12', morning: '', evening: 'بالی زاده', night: 'بالی زاده' },
  { date: '14/12', morning: 'آرزویی', evening: 'مظفری', night: 'مظفری' },
  { date: '15/12', morning: 'براتی', evening: 'براتی', night: '' },
  { date: '16/12', morning: '', evening: 'آرزویی', night: 'آرزویی' },
  { date: '17/12', morning: 'آرزویی', evening: 'معصومی', night: 'معصومی' },
  { date: '18/12', morning: '', evening: '', night: 'امین دزفولی' },
  { date: '19/12', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '20/12', morning: 'عباسی', evening: 'احمدی', night: '' },
  { date: '21/12', morning: 'آرزویی', evening: 'عباسی', night: 'امین دزفولی' },
  { date: '22/12', morning: 'احمدی', evening: 'احمدی', night: '' },
  { date: '23/12', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '24/12', morning: '', evening: 'حسن نژاد', night: 'حسن نژاد' },
  { date: '25/12', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '26/12', morning: '', evening: 'قلاوند', night: 'قلاوند' },
  { date: '27/12', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '28/12', morning: 'آرزویی', evening: 'شمی پور', night: '' },
  { date: '29/12', morning: 'امین دزفولی', evening: 'امین دزفولی', night: '' }
];

export default function App() {
  const [activeTab, setActiveTab] = useState('infectious');
  const [tailwindLoaded, setTailwindLoaded] = useState(false);

  // --- سیستم اجرای اجباری گرافیک برای سرورهایی مثل Vercel ---
  useEffect(() => {
    // Only run this logic on the client side
    if (typeof window !== 'undefined') {
      const existingScript = document.getElementById('tailwind-cdn');
      if (!existingScript) {
        const script = document.createElement('script');
        script.id = 'tailwind-cdn';
        script.src = 'https://cdn.tailwindcss.com';
        script.onload = () => setTailwindLoaded(true);
        // Sometimes Vercel's strict CSP blocks document.head.appendChild
        // So we append to body to bypass some restrictive header policies
        document.body.appendChild(script);
      } else {
        setTailwindLoaded(true);
      }
    }
  }, []);

  // --- Statistics Calculation ---
  const calculateSingleStats = (data) => {
    const stats = {};
    data.forEach(item => {
      if (item.doctor) {
        stats[item.doctor] = (stats[item.doctor] || 0) + 1;
      }
    });
    return Object.entries(stats).sort((a, b) => b[1] - a[1]);
  };

  const calculateMultiStats = (data) => {
    const stats = {};
    data.forEach(item => {
      ['morning', 'evening', 'night'].forEach(shift => {
        const doc = item[shift];
        if (doc && doc.trim() !== '' && doc !== '---') {
          stats[doc] = (stats[doc] || 0) + 1;
        }
      });
    });
    return Object.entries(stats).sort((a, b) => b[1] - a[1]);
  };

  const infectiousStats = useMemo(() => calculateSingleStats(infectiousData), []);
  const internalStats = useMemo(() => calculateSingleStats(internalData), []);
  const shafaStats = useMemo(() => calculateMultiStats(shafaData), []);

  // --- Components ---
  const StatCard = ({ doctor, count, colorClass }) => (
    <div className={`flex items-center justify-between p-4 rounded-2xl shadow-sm border border-slate-100 bg-white hover:shadow-lg hover:-translate-y-1 transition-all duration-300`}>
      <div className="flex items-center gap-3">
        <div className={`p-2.5 rounded-xl ${colorClass.replace('border-', 'bg-').replace('300', '50')} border border-slate-50`}>
          <UserIcon size={20} className={colorClass.replace('border-', 'text-').replace('300', '600')} />
        </div>
        <span className="font-bold text-slate-700">{doctor}</span>
      </div>
      <div className="flex flex-col items-center bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
        <span className={`text-xl font-black ${colorClass.replace('border-', 'text-').replace('300', '600')}`}>{count}</span>
        <span className="text-[10px] text-slate-500 font-bold">شیفت</span>
      </div>
    </div>
  );

  const StatsGrid = ({ stats, colorClass }) => (
    <div className="mb-8">
      <div className="flex items-center gap-2 mb-4 px-1">
        <ActivityIcon size={24} className={colorClass.replace('border-', 'text-').replace('300', '600')} />
        <h2 className="text-xl font-bold text-slate-800 tracking-tight">آمار کلی شیفت‌ها (اسفند ۱۴۰۴)</h2>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
        {stats.map(([doctor, count], idx) => (
          <StatCard key={idx} doctor={doctor} count={count} colorClass={colorClass} />
        ))}
      </div>
    </div>
  );

  const SingleColumnTable = ({ data, title, colorClass }) => (
    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
      <div className={`p-5 ${colorClass.replace('border-', 'bg-').replace('300', '50/70')} border-b border-slate-100 flex items-center gap-3`}>
        <CalendarIcon size={22} className={colorClass.replace('border-', 'text-').replace('300', '600')} />
        <h3 className="font-bold text-slate-800 text-lg">{title}</h3>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-right">
          <thead>
            <tr className="bg-slate-50/50 text-slate-500 border-b border-slate-100 text-sm">
              <th className="p-4 font-bold w-1/3">تاریخ</th>
              <th className="p-4 font-bold">نام پزشک کشیک</th>
            </tr>
          </thead>
          <tbody>
            {data.map((row, idx) => (
              <tr key={idx} className="border-b border-slate-50 hover:bg-slate-50 transition-colors group">
                <td className="p-4 font-medium text-slate-800 flex items-center gap-3">
                  <div className={`w-9 h-9 rounded-xl ${colorClass.replace('border-', 'bg-').replace('300', '50')} flex items-center justify-center text-sm font-bold ${colorClass.replace('border-', 'text-').replace('300', '700')} group-hover:scale-110 transition-transform`}>
                    {row.date.split('/')[0]}
                  </div>
                  <span className="text-slate-500">اسفند</span>
                </td>
                <td className="p-4 text-slate-700 font-bold">{row.doctor}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );

  const MultiColumnTable = ({ data, title, colorClass }) => (
    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
      <div className={`p-5 ${colorClass.replace('border-', 'bg-').replace('300', '50/70')} border-b border-slate-100 flex items-center gap-3`}>
        <HospitalIcon size={22} className={colorClass.replace('border-', 'text-').replace('300', '600')} />
        <h3 className="font-bold text-slate-800 text-lg">{title}</h3>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-right">
          <thead>
            <tr className="bg-slate-50/50 text-slate-500 border-b border-slate-100 text-sm">
              <th className="p-4 font-bold w-32">تاریخ</th>
              <th className="p-4 font-bold text-orange-500"><div className="flex items-center gap-1.5"><SunIcon size={18}/> صبح</div></th>
              <th className="p-4 font-bold text-purple-500"><div className="flex items-center gap-1.5"><SunsetIcon size={18}/> عصر</div></th>
              <th className="p-4 font-bold text-indigo-500"><div className="flex items-center gap-1.5"><MoonIcon size={18}/> شب</div></th>
            </tr>
          </thead>
          <tbody>
            {data.map((row, idx) => (
              <tr key={idx} className="border-b border-slate-50 hover:bg-slate-50 transition-colors group">
                <td className="p-4 font-medium text-slate-800 flex items-center gap-3">
                   <div className={`w-9 h-9 rounded-xl ${colorClass.replace('border-', 'bg-').replace('300', '50')} flex items-center justify-center text-sm font-bold ${colorClass.replace('border-', 'text-').replace('300', '700')} group-hover:scale-110 transition-transform`}>
                    {row.date.split('/')[0]}
                  </div>
                  <span className="text-slate-500">اسفند</span>
                </td>
                <td className="p-4 font-bold text-slate-700">{row.morning || <span className="text-slate-300 font-normal">--</span>}</td>
                <td className="p-4 font-bold text-slate-700">{row.evening || <span className="text-slate-300 font-normal">--</span>}</td>
                <td className="p-4 font-bold text-slate-700">{row.night || <span className="text-slate-300 font-normal">--</span>}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );

  return (
    <div dir="rtl" className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 text-gray-800 p-4 md:p-8" style={{ fontFamily: '"Vazirmatn", system-ui, sans-serif' }}>
      
      {/* Import Vazirmatn Font */}
      <style>{`
        @import url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.0.0/Vazirmatn-font-face.css');
        
        /* A simple fallback style block in case Tailwind completely fails to load */
        ${!tailwindLoaded ? `
          body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
          .max-w-7xl { max-width: 1200px; margin: 0 auto; }
          .mb-8 { margin-bottom: 2rem; }
          .p-4 { padding: 1rem; }
          .flex { display: flex; }
          .justify-between { justify-content: space-between; }
          .gap-4 { gap: 1rem; }
          .text-2xl { font-size: 1.5rem; font-weight: bold; }
          .grid { display: grid; }
          .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
          table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
          th { background-color: #f2f2f2; }
          .bg-white { background-color: white; border-radius: 8px; padding: 16px; margin-bottom: 20px;}
          button { padding: 10px 20px; margin-left: 10px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 5px;}
        ` : ''}
      `}</style>

      <div className="max-w-7xl mx-auto">
        
        {/* Header */}
        <header className="mb-8 bg-white/80 backdrop-blur-md p-6 rounded-3xl shadow-sm border border-white flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-5">
            <div className="bg-gradient-to-tr from-blue-600 to-indigo-500 p-3.5 rounded-2xl text-white shadow-lg shadow-blue-200">
              <CalendarIcon size={32} strokeWidth={1.5} />
            </div>
            <div>
              <h1 className="text-2xl md:text-3xl font-black text-slate-800 tracking-tight">برنامه کشیک پزشکان</h1>
              <p className="text-slate-500 font-medium mt-1">اسفند ماه ۱۴۰۴ - بیمارستان‌های گلستان و شفا</p>
            </div>
          </div>
          <div className="flex items-center gap-2 bg-indigo-50/80 px-4 py-2.5 rounded-xl text-sm font-bold text-indigo-700 border border-indigo-100/50">
            <UsersIcon size={18} />
            <span>گزارش جامع شیفت‌ها</span>
          </div>
        </header>

        {/* Tabs */}
        <div className="flex flex-wrap gap-2 mb-8 bg-white/60 p-2 rounded-2xl shadow-sm border border-slate-100 backdrop-blur-sm">
          <button
            onClick={() => setActiveTab('infectious')}
            className={`flex-1 flex items-center justify-center gap-2 py-3.5 px-4 rounded-xl font-bold transition-all duration-300 ${
              activeTab === 'infectious' 
                ? 'bg-gradient-to-r from-emerald-500 to-teal-400 text-white shadow-md shadow-emerald-200 transform scale-[1.02]' 
                : 'text-slate-600 hover:bg-white hover:shadow-sm'
            }`}
          >
            <ActivityIcon size={20} />
            بخش عفونی - گلستان
          </button>
          <button
            onClick={() => setActiveTab('internal')}
            className={`flex-1 flex items-center justify-center gap-2 py-3.5 px-4 rounded-xl font-bold transition-all duration-300 ${
              activeTab === 'internal' 
                ? 'bg-gradient-to-r from-blue-500 to-indigo-400 text-white shadow-md shadow-blue-200 transform scale-[1.02]' 
                : 'text-slate-600 hover:bg-white hover:shadow-sm'
            }`}
          >
            <UserIcon size={20} />
            بخش داخلی - گلستان
          </button>
          <button
            onClick={() => setActiveTab('shafa')}
            className={`flex-1 flex items-center justify-center gap-2 py-3.5 px-4 rounded-xl font-bold transition-all duration-300 ${
              activeTab === 'shafa' 
                ? 'bg-gradient-to-r from-purple-500 to-fuchsia-400 text-white shadow-md shadow-purple-200 transform scale-[1.02]' 
                : 'text-slate-600 hover:bg-white hover:shadow-sm'
            }`}
          >
            <HospitalIcon size={20} />
            بیمارستان شفا
          </button>
        </div>

        {/* Tab Content */}
        <div className="transition-all duration-300 min-h-[500px]">
          {activeTab === 'infectious' && (
            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
              <StatsGrid stats={infectiousStats} colorClass="border-emerald-300" />
              <SingleColumnTable data={infectiousData} title="لیست کشیک روزانه بخش عفونی" colorClass="border-emerald-300" />
            </div>
          )}

          {activeTab === 'internal' && (
            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
              <StatsGrid stats={internalStats} colorClass="border-blue-300" />
              <SingleColumnTable data={internalData} title="لیست کشیک روزانه بخش داخلی" colorClass="border-blue-300" />
            </div>
          )}

          {activeTab === 'shafa' && (
            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
              <StatsGrid stats={shafaStats} colorClass="border-purple-300" />
              <MultiColumnTable data={shafaData} title="لیست کشیک بیمارستان شفا (صبح، عصر، شب)" colorClass="border-purple-300" />
            </div>
          )}
        </div>

      </div>
    </div>
  );
}
