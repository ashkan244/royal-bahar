import React, { useState, useMemo } from 'react';

// ==========================================
// 1. DATA PREPARATION (Updated to exact final request)
// ==========================================
const infectiousData = [
  { date: '1', doctor: 'دارابی' }, { date: '2', doctor: 'پوراحسانی' },
  { date: '3', doctor: 'پوراحسانی' }, { date: '4', doctor: 'آرزویی' },
  { date: '5', doctor: 'آرزویی' }, { date: '6', doctor: 'پوراحسانی' },
  { date: '7', doctor: 'شمی پور' }, { date: '8', doctor: 'شمی پور' },
  { date: '9', doctor: 'پوراحسانی' }, { date: '10', doctor: 'پوراحسانی' },
  { date: '11', doctor: 'دارابی' }, { date: '12', doctor: 'دارابی' },
  { date: '13', doctor: 'دارابی' }, { date: '14', doctor: 'رضوی' },
  { date: '15', doctor: 'دارابی' }, { date: '16', doctor: 'دارابی' },
  { date: '17', doctor: 'پوراحسانی' }, { date: '18', doctor: 'آرزویی' },
  { date: '19', doctor: 'آرزویی' }, { date: '20', doctor: 'پوراحسانی' },
  { date: '21', doctor: 'معارفی' }, { date: '22', doctor: 'معارفی' },
  { date: '23', doctor: 'پوراحسانی' }, { date: '24', doctor: 'پوراحسانی' },
  { date: '25', doctor: 'آرزویی' }, { date: '26', doctor: 'آرزویی' },
  { date: '27', doctor: 'پوراحسانی' }, { date: '28', doctor: 'معارفی' },
  { date: '29', doctor: 'شمی پور' }
];

const internalData = [
  { date: '1', doctor: 'معارفی' }, { date: '2', doctor: 'حسن نژاد' },
  { date: '3', doctor: 'معارفی' }, { date: '4', doctor: 'شمی پور' },
  { date: '5', doctor: 'قلاوند' }, { date: '6', doctor: 'مظفری' },
  { date: '7', doctor: 'شمی پور' }, { date: '8', doctor: 'شمی پور' },
  { date: '9', doctor: 'مظفری' }, { date: '10', doctor: 'معارفی' },
  { date: '11', doctor: 'حسن نژاد' }, { date: '12', doctor: 'معارفی' },
  { date: '13', doctor: 'پورکاوه' }, { date: '14', doctor: 'شمی پور' },
  { date: '15', doctor: 'پورکاوه' }, { date: '16', doctor: 'شمی پور' },
  { date: '17', doctor: 'پورکاوه' }, { date: '18', doctor: 'قلاوند' },
  { date: '19', doctor: 'حسن نژاد' }, { date: '20', doctor: 'پورکاوه' },
  { date: '21', doctor: 'معارفی' }, { date: '22', doctor: 'معارفی' },
  { date: '23', doctor: 'شمی پور' }, { date: '24', doctor: 'حسن نژاد' },
  { date: '25', doctor: 'معارفی' }, { date: '26', doctor: 'معارفی' },
  { date: '27', doctor: 'شمی پور' }, { date: '28', doctor: 'معارفی' },
  { date: '29', doctor: 'شمی پور' }
];

const shafaData = [
  { date: '1', morning: 'علی مرادی', evening: 'علی مرادی', night: '' },
  { date: '2', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '3', morning: '', evening: 'بالی زاده', night: 'بالی زاده' },
  { date: '4', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '5', morning: '', evening: 'بالی زاده', night: 'بالی زاده' },
  { date: '6', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '7', morning: 'آرزویی', evening: 'حسن نژاد', night: 'حسن نژاد' },
  { date: '8', morning: 'علی مرادی', evening: 'حسن نژاد', night: 'حسن نژاد' },
  { date: '9', morning: '', evening: 'عباسی', night: 'آرزویی' },
  { date: '10', morning: '', evening: 'شمی پور', night: 'شمی پور' },
  { date: '11', morning: '', evening: 'قلاوند', night: 'قلاوند' },
  { date: '12', morning: '', evening: 'مظفری', night: 'مظفری' },
  { date: '13', morning: '', evening: 'بالی زاده', night: 'بالی زاده' },
  { date: '14', morning: 'آرزویی', evening: 'مظفری', night: 'مظفری' },
  { date: '15', morning: 'براتی', evening: 'براتی', night: '' },
  { date: '16', morning: '', evening: 'آرزویی', night: 'آرزویی' },
  { date: '17', morning: 'آرزویی', evening: 'معصومی', night: 'معصومی' },
  { date: '18', morning: '', evening: '', night: 'امین دزفولی' },
  { date: '19', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '20', morning: 'عباسی', evening: 'احمدی', night: '' },
  { date: '21', morning: 'آرزویی', evening: 'عباسی', night: 'امین دزفولی' },
  { date: '22', morning: 'احمدی', evening: 'احمدی', night: '' },
  { date: '23', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '24', morning: '', evening: 'حسن نژاد', night: 'حسن نژاد' },
  { date: '25', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '26', morning: '', evening: 'قلاوند', night: 'قلاوند' },
  { date: '27', morning: '', evening: 'احمدی', night: 'امین دزفولی' },
  { date: '28', morning: 'آرزویی', evening: 'شمی پور', night: '' },
  { date: '29', morning: 'امین دزفولی', evening: 'امین دزفولی', night: '' }
];

// ==========================================
// 2. SVG ICONS (Native & Lightweight)
// ==========================================
const SvgIcon = ({ d, color = "currentColor", size = 20 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d={d} />
  </svg>
);

const Icons = {
  Doctor: () => <SvgIcon d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" />,
  Calendar: () => <SvgIcon d="M3 4a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4z M16 2v4 M8 2v4 M3 10h18" />,
  Hospital: () => <SvgIcon d="M12 6v4 M14 14h-4 M14 18h-4 M14 8h-4 M18 12h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h2 M18 22V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v18" />,
  Sun: () => <SvgIcon d="M12 2v2 M12 20v2 M4.93 4.93l1.41 1.41 M17.66 17.66l1.41 1.41 M2 12h2 M20 12h2 M6.34 17.66l-1.41 1.41 M19.07 4.93l-1.41 1.41 M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" color="#f59e0b" />,
  Sunset: () => <SvgIcon d="M12 10V2 M4.93 10.93l1.41 1.41 M2 18h2 M20 18h2 M19.07 10.93l-1.41 1.41 M22 22H2 M16 6l-4-4-4 4 M16 18a4 4 0 0 0-8 0" color="#8b5cf6" />,
  Moon: () => <SvgIcon d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9z" color="#3b82f6" />,
  Print: () => <SvgIcon d="M6 9V2h12v7 M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2 M6 14h12v8H6z" />
};

// ==========================================
// 3. BULLETPROOF CSS INJECTION
// ==========================================
const MEDICAL_STYLES = `
@import url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.0.0/Vazirmatn-font-face.css');

:root {
  --primary: #0f766e;
  --primary-light: #ccfbf1;
  --bg-color: #f1f5f9;
  --card-bg: #ffffff;
  --text-main: #0f172a;
  --text-muted: #64748b;
  --border-color: #e2e8f0;
  --radius: 16px;
  --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Vazirmatn', Tahoma, sans-serif;
  background-color: var(--bg-color);
  color: var(--text-main);
  direction: rtl;
  line-height: 1.6;
}

.mc-layout {
  max-width: 1100px;
  margin: 2rem auto;
  padding: 0 1.5rem;
}

/* --- Top Navigation --- */
.mc-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--card-bg);
  padding: 1.5rem 2rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 2rem;
  border-right: 6px solid var(--primary);
}
.mc-header-titles h1 { font-size: 1.8rem; font-weight: 900; color: var(--primary); }
.mc-header-titles p { font-size: 1rem; color: var(--text-muted); font-weight: 500; }
.mc-print-btn {
  display: flex; gap: 8px; align-items: center;
  background: var(--primary-light); color: var(--primary);
  border: none; padding: 10px 16px; border-radius: 8px;
  font-weight: 700; cursor: pointer; transition: 0.2s;
}
.mc-print-btn:hover { background: var(--primary); color: white; }

/* --- Segmented Controls (Tabs) --- */
.mc-tabs {
  display: flex; gap: 10px; background: var(--card-bg);
  padding: 8px; border-radius: 12px; margin-bottom: 2rem;
  box-shadow: var(--shadow);
}
.mc-tab {
  flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 14px 20px; border: none; background: transparent;
  color: var(--text-muted); font-size: 1.1rem; font-weight: 700;
  border-radius: 8px; cursor: pointer; transition: 0.3s all;
}
.mc-tab:hover { background: var(--bg-color); }
.mc-tab.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3); }

/* --- Summary Cards --- */
.mc-stats-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem; margin-bottom: 2.5rem;
}
.mc-stat-card {
  background: var(--card-bg); padding: 1.25rem;
  border-radius: 12px; box-shadow: var(--shadow);
  display: flex; align-items: center; justify-content: space-between;
  border: 1px solid var(--border-color); transition: 0.3s transform;
}
.mc-stat-card:hover { transform: translateY(-3px); border-color: var(--primary); }
.mc-stat-info { display: flex; align-items: center; gap: 12px; }
.mc-stat-avatar {
  background: var(--primary-light); color: var(--primary);
  width: 44px; height: 44px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
}
.mc-stat-name { font-weight: 800; font-size: 1.05rem; }
.mc-stat-value {
  background: var(--bg-color); padding: 6px 12px;
  border-radius: 6px; font-weight: 900; font-size: 1.2rem; color: var(--primary);
}

/* --- Medical Data Table --- */
.mc-table-wrapper {
  background: var(--card-bg); border-radius: var(--radius);
  box-shadow: var(--shadow); overflow: hidden;
}
.mc-table-header {
  padding: 1.5rem; background: #f8fafc; border-bottom: 1px solid var(--border-color);
  display: flex; align-items: center; gap: 10px; font-weight: 900; color: #334155; font-size: 1.2rem;
}
.mc-table { width: 100%; border-collapse: collapse; text-align: right; }
.mc-table th {
  padding: 1.25rem 1.5rem; font-weight: 800; color: var(--text-muted);
  border-bottom: 2px solid var(--border-color); background: white;
}
.mc-table td {
  padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color);
  font-weight: 700; color: #1e293b; transition: 0.2s;
}
.mc-table tr:hover td { background-color: var(--primary-light); }

/* Custom elements inside table */
.mc-day-pill {
  display: inline-flex; align-items: center; justify-content: center;
  background: var(--primary); color: white;
  width: 32px; height: 32px; border-radius: 8px; margin-left: 10px; font-size: 1.1rem;
}
.mc-empty { color: #cbd5e1; font-weight: 400; }
.shift-header { display: flex; align-items: center; gap: 6px; }

/* --- Responsive --- */
@media (max-width: 768px) {
  .mc-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
  .mc-tabs { flex-direction: column; }
  .mc-table th, .mc-table td { padding: 1rem; font-size: 0.95rem; }
}

/* --- Print Styles --- */
@media print {
  body { background: white; }
  .mc-layout { margin: 0; padding: 0; max-width: 100%; }
  .mc-tabs, .mc-print-btn, .mc-stats-grid { display: none !important; }
  .mc-header { box-shadow: none; border: 1px solid black; margin-bottom: 1rem; }
  .mc-table-wrapper { box-shadow: none; border: 1px solid black; }
  .mc-table th, .mc-table td { border-bottom: 1px solid black; }
  .mc-day-pill { background: transparent; color: black; border: 1px solid black; }
}
`;

// ==========================================
// 4. MAIN APP COMPONENT
// ==========================================
export default function App() {
  const [activeTab, setActiveTab] = useState('infectious');

  // --- Logic for counting shifts ---
  const calculateStats = (data, isShafa = false) => {
    const stats = {};
    if (!isShafa) {
      data.forEach(item => {
        if (item.doctor && item.doctor !== '---') {
          stats[item.doctor] = (stats[item.doctor] || 0) + 1;
        }
      });
    } else {
      data.forEach(item => {
        ['morning', 'evening', 'night'].forEach(shift => {
          const doc = item[shift];
          if (doc && doc.trim() !== '' && doc !== '---') {
            stats[doc] = (stats[doc] || 0) + 1;
          }
        });
      });
    }
    return Object.entries(stats).sort((a, b) => b[1] - a[1]);
  };

  const currentData = useMemo(() => {
    if (activeTab === 'infectious') return infectiousData;
    if (activeTab === 'internal') return internalData;
    return shafaData;
  }, [activeTab]);

  const currentStats = useMemo(() => calculateStats(currentData, activeTab === 'shafa'), [currentData, activeTab]);

  const getTitle = () => {
    if (activeTab === 'infectious') return 'برنامه روزانه بخش عفونی (گلستان)';
    if (activeTab === 'internal') return 'برنامه روزانه بخش داخلی (گلستان)';
    return 'برنامه روزانه بیمارستان شفا';
  };

  return (
    <>
      {/* This is the magic bullet. It injects RAW CSS directly into the DOM.
        Vercel/Next.js CANNOT strip this out during build. It guarantees the styling.
      */}
      <style dangerouslySetInnerHTML={{ __html: MEDICAL_STYLES }} />

      <div className="mc-layout">
        
        {/* Header Section */}
        <header className="mc-header">
          <div className="mc-header-titles">
            <h1>سیستم مدیریت کشیک پزشکان</h1>
            <p>برنامه زمانی اسفند ۱۴۰۴ - نسخه نهایی</p>
          </div>
          <button className="mc-print-btn" onClick={() => window.print()}>
            <Icons.Print />
            چاپ برنامه
          </button>
        </header>

        {/* Segmented Controls */}
        <nav className="mc-tabs">
          <button 
            className={`mc-tab ${activeTab === 'infectious' ? 'active' : ''}`}
            onClick={() => setActiveTab('infectious')}
          >
            <Icons.Hospital />
            عفونی - گلستان
          </button>
          <button 
            className={`mc-tab ${activeTab === 'internal' ? 'active' : ''}`}
            onClick={() => setActiveTab('internal')}
          >
            <Icons.Doctor />
            داخلی - گلستان
          </button>
          <button 
            className={`mc-tab ${activeTab === 'shafa' ? 'active' : ''}`}
            onClick={() => setActiveTab('shafa')}
          >
            <Icons.Calendar />
            بیمارستان شفا
          </button>
        </nav>

        {/* Statistics Board */}
        <div className="mc-stats-grid">
          {currentStats.map(([doctor, count], index) => (
            <div className="mc-stat-card" key={index}>
              <div className="mc-stat-info">
                <div className="mc-stat-avatar"><Icons.Doctor /></div>
                <span className="mc-stat-name">{doctor}</span>
              </div>
              <div className="mc-stat-value">{count}</div>
            </div>
          ))}
        </div>

        {/* Data Table */}
        <div className="mc-table-wrapper">
          <div className="mc-table-header">
            <Icons.Calendar />
            <span>{getTitle()}</span>
          </div>
          
          <table className="mc-table">
            <thead>
              {activeTab === 'shafa' ? (
                <tr>
                  <th style={{ width: '20%' }}>تاریخ (اسفند)</th>
                  <th style={{ width: '26%' }}><div className="shift-header"><Icons.Sun /> شیفت صبح</div></th>
                  <th style={{ width: '26%' }}><div className="shift-header"><Icons.Sunset /> شیفت عصر</div></th>
                  <th style={{ width: '26%' }}><div className="shift-header"><Icons.Moon /> شیفت شب</div></th>
                </tr>
              ) : (
                <tr>
                  <th style={{ width: '30%' }}>تاریخ (اسفند)</th>
                  <th>نام پزشک رجیستر</th>
                </tr>
              )}
            </thead>
            <tbody>
              {currentData.map((row, idx) => (
                <tr key={idx}>
                  <td>
                    <div className="mc-day-pill">{row.date}</div>
                  </td>
                  
                  {activeTab === 'shafa' ? (
                    <>
                      <td>{row.morning ? row.morning : <span className="mc-empty">ندارد</span>}</td>
                      <td>{row.evening ? row.evening : <span className="mc-empty">ندارد</span>}</td>
                      <td>{row.night ? row.night : <span className="mc-empty">ندارد</span>}</td>
                    </>
                  ) : (
                    <td>{row.doctor}</td>
                  )}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

      </div>
    </>
  );
}
